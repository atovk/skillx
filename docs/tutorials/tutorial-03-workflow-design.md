# 教程 3: 工作流设计

设计清晰、有效的工作流是创建优秀 Skill 的关键。本教程将教你如何设计易于理解和执行的工作流。

## 教程目标

完成本教程后，你将：

- 理解工作流设计的原则
- 掌握设计多步骤任务的技巧
- 学会处理条件和分支
- 能够创建用户友好的 Skills

## 什么是工作流？

**工作流**是指完成任务的步骤序列。在 Claude Code Skills 中，工作流定义了 Claude 如何与用户交互、处理信息、产生输出。

### 简单工作流示例

```
开始 → 询问输入 → 处理 → 显示结果 → 结束
```

### 复杂工作流示例

```
开始 → 验证输入 → 选择操作 → 处理 → 确认 → 执行 → 验证 → 结束
        ↓ 失败
      显示错误 → 重新输入
```

## 工作流设计原则

### 1. 清晰性（Clarity）

每个步骤应该：

- ✅ 有明确的目的
- ✅ 易于理解
- ✅ 有清晰的输出

❌ 不好的工作流：

```markdown
处理用户请求，做些事情，可能显示结果
```

✅ 好的工作流：

```markdown
## 工作流程

1. **收集信息** - 询问用户的具体需求
2. **分析请求** - 理解用户想要什么
3. **执行操作** - 执行相应的操作
4. **显示结果** - 清晰展示结果
```

### 2. 线性流程（Linear Flow）

尽量保持线性流程，避免复杂的跳转：

✅ 线性流程：

```
步骤 1 → 步骤 2 → 步骤 3 → 完成
```

❌ 复杂跳转：

```
步骤 1 → 步骤 2 → 步骤 3
   ↓         ↑
步骤 4 ← 步骤 5
```

### 3. 可预测性（Predictability）

用户应该能预测下一步发生什么：

```markdown
### 步骤 1/3: 收集信息

我将询问你几个问题：
1. 项目名称
2. 编程语言
3. 需要的功能

准备好后，我们继续到步骤 2。

### 步骤 2/3: 生成代码
...
```

## 设计工作流的步骤

### 步骤 1: 明确目标

首先，清楚地定义 Skill 要达成什么目标。

**示例**：代码审查助手

**目标**：帮助用户审查代码质量，提供改进建议

### 步骤 2: 识别关键步骤

列出完成目标需要的关键步骤。

1. 识别要审查的文件
2. 读取代码
3. 分析代码质量
4. 生成审查报告
5. 提供改进建议

### 步骤 3: 组织步骤顺序

将步骤按逻辑顺序排列：

```markdown
## 工作流程

### 第 1 步: 识别文件
询问用户要审查哪个文件

### 第 2 步: 读取代码
使用 Read 工具读取文件内容

### 第 3 步: 分析代码
检查代码质量、风格、潜在问题

### 第 4 步: 生成报告
格式化输出审查结果

### 第 5 步: 提供建议
给出具体的改进建议
```

### 步骤 4: 添加细节和说明

为每个步骤添加详细信息：

```markdown
### 第 1 步: 识别文件

询问用户要审查哪个文件：
- 支持相对路径和绝对路径
- 验证文件是否存在
- 如果文件不存在，提示用户并提供示例

**输出**: 文件路径和确认信息
```

### 步骤 5: 处理错误和边界情况

考虑可能出错的地方：

```markdown
### 错误处理

**文件不存在**:
```

❌ 错误：文件不存在
文件 'xyz.js' 找不到。

请检查：

1. 文件路径是否正确
2. 文件是否在当前目录

```

**文件过大**:
```

⚠️ 警告：文件较大
文件超过 1000 行，分析可能需要更长时间。
是否继续？(y/n)

```
```

## 工作流模式

### 模式 1: 线性工作流

最简单的工作流，步骤按顺序执行。

**适用场景**：简单的、一次性任务

**示例**：文件重命名器

```markdown
## 工作流程

1. **询问当前文件名**
2. **询问新文件名**
3. **确认重命名**
4. **执行重命名**
5. **显示结果**
```

### 模式 2: 分支工作流

根据用户选择或条件执行不同路径。

**适用场景**：有多种操作选项

**示例**：代码片段管理器

```markdown
## 工作流程

### 1. 选择操作

询问用户想做什么：
- A) 保存新片段
- B) 搜索片段
- C) 列出所有片段

### 2A. 保存新片段
[保存流程...]

### 2B. 搜索片段
[搜索流程...]

### 2C. 列出所有片段
[列出流程...]
```

### 模式 3: 迭代工作流

重复执行某个步骤，直到满足条件。

**适用场景**：处理多个项目

**示例**：批量文件处理

```markdown
## 工作流程

1. **识别文件列表**
   - 使用 Glob 查找所有匹配的文件

2. **遍历文件**
   对每个文件：
   - 读取内容
   - 处理内容
   - 保存修改
   - 显示进度

3. **总结**
   - 显示处理了多少文件
   - 列出成功和失败的情况
```

### 模式 4: 确认工作流

在关键操作前请求用户确认。

**适用场景**：破坏性操作

**示例**：文件删除器

```markdown
## 工作流程

1. **识别要删除的文件**
2. **显示删除预览**
   ```

   将删除以下文件：

- file1.txt
- file2.txt
- old-dir/

   ```
3. **请求确认**
   ```

   确认删除？(y/n)

   ```
4. **执行删除**
   - 只在用户确认后执行
5. **显示结果**
```

## 实践：设计工作流

### 场景：日志分析器

让我们设计一个日志分析器的工作流。

#### 第 1 步：明确目标

**目标**：分析日志文件，提取关键信息，生成报告

#### 第 2 步：识别步骤

1. 获取日志文件路径
2. 读取日志内容
3. 分析日志（错误、警告、访问等）
4. 生成统计报告
5. （可选）保存报告

#### 第 3 步：组织工作流

```markdown
## 工作流程

### 第 1 步: 获取日志文件

询问用户要分析的日志文件：
- 支持单个文件或目录
- 验证文件存在且可读
- 显示文件大小和行数

### 第 2 步: 读取日志内容

使用 Read 工具读取文件：
- 处理大文件（分块读取）
- 识别日志格式

### 第 3 步: 分析日志

统计并分类：
- 错误（ERROR）数量和内容
- 警告（WARN）数量和内容
- 信息（INFO）数量
- 按时间分布
- 按严重程度分组

### 第 4 步: 生成报告

格式化输出：
```markdown
# 日志分析报告

**文件**: app.log
**大小**: 2.5 MB
**行数**: 15,000

## 统计概览

| 级别 | 数量 | 百分比 |
|------|------|--------|
| ERROR | 45 | 0.3% |
| WARN | 230 | 1.5% |
| INFO | 14,725 | 98.2% |

## 错误详情
[列出所有错误...]

## 时间分布
[按时间统计...]
```

### 第 5 步: 保存报告（可选）

询问用户是否保存报告到文件。

```

## 输出格式设计

### 清晰的进度指示

```markdown
### 第 1 步/5: 获取日志文件 ⏳

正在分析日志文件: app.log
- 文件大小: 2.5 MB
- 预计时间: 10 秒

### 第 2 步/5: 读取日志内容 ✅

已读取 15,000 行日志

### 第 3 步/5: 分析日志 ⏳

正在分析...
- 发现 45 个错误
- 发现 230 个警告
```

### 友好的错误信息

```markdown
### ❌ 错误：无法读取文件

文件 `app.log` 无法读取。

可能的原因：
1. 文件权限不足
2. 文件被其他程序占用
3. 文件路径不正确

建议：
- 检查文件权限：`ls -l app.log`
- 确认文件存在：`file app.log`
- 尝试使用绝对路径
```

## 常见错误

### 错误 1: 步骤不清晰

❌ 不好的工作流：

```markdown
处理文件并生成报告
```

✅ 好的工作流：

```markdown
## 工作流程

1. **读取文件** - 使用 Read 工具
2. **处理内容** - 分析和转换
3. **生成报告** - 格式化输出
```

### 错误 2: 缺少确认

❌ 危险的操作没有确认：

```markdown
## 删除文件

直接删除用户指定的文件
```

✅ 添加确认步骤：

```markdown
## 删除文件

1. **显示删除预览**
2. **请求用户确认**
3. **执行删除**
```

### 错误 3: 没有错误处理

❌ 没有考虑错误情况：

```markdown
## 处理文件

读取并处理文件内容
```

✅ 包含错误处理：

```markdown
## 处理文件

### 正常情况
读取并处理文件内容

### 错误情况
- 文件不存在：提示用户
- 权限不足：显示权限错误
- 格式错误：显示友好错误信息
```

## 实践练习

### 练习 1: 为这个 Skill 设计工作流

**Skill**: 数据库备份助手

**功能**: 备份数据库到指定位置

请设计清晰的工作流，包括：

1. 主要步骤
2. 错误处理
3. 确认机制

### 练习 2: 改进这个工作流

**原始工作流**:

```markdown
处理用户请求并返回结果
```

**改进它**，使其更清晰、更安全。

## 总结

工作流设计的关键原则：

1. **清晰性** - 每个步骤目的明确
2. **线性流程** - 避免复杂跳转
3. **可预测性** - 用户知道下一步
4. **错误处理** - 考虑所有边界情况
5. **确认机制** - 危险操作需要确认
6. **进度反馈** - 显示当前进度

## 下一步

1. **练习**：完成 [中级练习 8：条件工作流](../../exercises/intermediate/exercise-08-conditional-workflow.md)
2. **学习**：阅读 [教程 4：测试 Skills](tutorial-04-testing-skills.md)
3. **探索**：查看更多 [示例 Skills](../../skills/)

## 参考资源

- [最佳实践：工作流设计](../03-best-practices.md#工作流设计)
- [高级模式：协调器模式](../04-advanced-patterns.md)
- [测试工作流](tutorial-04-testing-skills.md)
