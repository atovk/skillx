# 练习 10: 添加错误处理

**难度**：⭐⭐ 中级
**预计时间**：30 分钟

## 学习目标

完成这个练习后，你将：

- 理解错误处理的重要性
- 掌握设计健壮 Skills 的方法
- 能够创建用户友好的错误处理

## 前置知识

- 完成中级练习 6-9
- 熟悉工具使用
- 理解基本工作流

## 任务描述

为现有的 Skill 添加完善的错误处理机制，使其更加健壮和用户友好。

## 错误类型

### 1. 输入错误

用户提供了无效或缺失的输入

```markdown
## 输入错误示例

❌ 文件路径为空
❌ 文件格式不正确
❌ 选项值无效
❌ 缺少必需参数
```

### 2. 文件系统错误

文件操作相关的问题

```markdown
## 文件系统错误示例

❌ 文件不存在
❌ 权限不足
❌ 目录不存在
❌ 磁盘空间不足
❌ 文件被占用
```

### 3. 工具调用错误

工具执行失败

```markdown
## 工具错误示例

❌ Read 工具失败
❌ Write 权限被拒绝
❌ Bash 命令执行失败
❌ Grep 没有找到结果
```

### 4. 逻辑错误

业务逻辑相关的问题

```markdown
## 逻辑错误示例

❌ 数据格式不符合预期
❌ 必需字段缺失
❌ 数值超出范围
❌ 状态不一致
```

## 错误处理模式

### 模式 1: 验证优先

在执行操作前先验证：

```markdown
## 错误处理策略

### 第 1 步: 验证输入
在操作前验证所有输入

### 第 2 步: 检查前置条件
确保满足执行条件

### 第 3 步: 执行操作
只有在验证通过后才执行

### 第 4 步: 验证结果
检查操作是否成功
```

### 模式 2: 友好提示

提供清晰的错误信息和解决方案：

```markdown
## 错误信息格式

### 标题
❌ 错误：[错误类型]

### 描述
[发生了什么]

### 可能原因
- 原因 1
- 原因 2

### 建议解决方案
- 方案 1
- 方案 2

### 示例
[正确示例]
```

### 模式 3: 优雅降级

在部分失败时提供降级方案：

```markdown
## 优雅降级

### 主要功能失败
尝试备选方案

### 示例
```markdown
❌ 无法连接到远程 API
→ 使用本地缓存数据

⚠️ 本地数据可能不是最新的
最后更新：2 小时前

是否继续使用本地数据？(y/n)
```

```

## 实践练习

### 练习 1: 文件操作错误处理

为文件读取操作添加错误处理：

```markdown
## 文件读取错误处理

### 检查 1: 文件是否存在
使用 Glob 检查文件

如果不存在：
```

❌ 错误：文件不存在

**文件**: xyz.js

请检查：

1. 文件路径是否正确
2. 文件是否在当前目录
3. 尝试使用绝对路径

示例：正确路径应该是 ./src/xyz.js

```

### 检查 2: 文件权限
如果无权限：
```

❌ 错误：权限不足

**文件**: config.json

无法读取文件，请检查权限。

建议：

- Linux/Mac: chmod 644 config.json
- Windows: 右键 → 属性 → 安全

```
```

### 练习 2: 输入验证错误处理

添加输入验证和错误提示：

```markdown
## 输入验证

### 端口号验证
如果用户输入的端口无效：
```

❌ 错误：无效的端口号

**输入**: abc

端口号必须是 1-65535 之间的数字。

正确示例：

- 开发环境: 3000
- 生产环境: 8080
- HTTPS: 443

请重新输入端口号：

```

### 文件路径验证
如果文件路径格式错误：
```

❌ 错误：文件路径格式无效

**输入**: C:\Users\file.txt (在 Linux 上)

当前系统是 Linux，但提供的是 Windows 路径。

正确的 Linux 路径格式：

- 相对路径: ./file.txt 或 ../parent/file.txt
- 绝对路径: /home/user/file.txt

请重新输入路径：

```
```

### 练习 3: 工具调用错误处理

处理工具调用失败：

```markdown
## 工具调用错误处理

### Bash 命令失败
```

❌ 错误：命令执行失败

**命令**: npm install

**错误信息**: Command failed: npm install

可能原因：

1. npm 未安装
2. package.json 有错误
3. 网络连接问题

建议解决方案：

1. 检查 npm 是否安装: npm --version
2. 验证 package.json 格式
3. 检查网络连接

是否重试？(y/n)

```

### Write 工具失败
```

❌ 错误：无法写入文件

**文件**: output.txt
**路径**: /protected/dir/output.txt

写入失败：权限不足

建议：

1. 检查目录权限
2. 尝试写入其他位置
3. 使用 sudo (仅当你了解风险)

备选位置：

- ~/output.txt
- ./output.txt
- /tmp/output.txt

是否尝试备选位置？(y/n)

```
```

## 错误信息模板

### 模板 1: 文件不存在

```markdown
❌ 错误：文件不存在

**文件**: {filename}

文件 "{filename}" 找不到。

**可能原因**:
- 文件路径不正确
- 文件已被删除或移动
- 当前目录错误

**建议**:
1. 检查文件路径: `ls -l {filename}`
2. 确认当前目录: `pwd`
3. 列出当前目录: `ls`
4. 尝试使用绝对路径

**正确示例**:
```

相对路径: ./src/main.js
绝对路径: /home/user/project/src/main.js

```
```

### 模板 2: 权限不足

```markdown
❌ 错误：权限不足

**操作**: {operation}
**资源**: {resource}

没有权限执行此操作。

**可能原因**:
- 文件只读
- 目录写保护
- 系统资源限制

**建议**:
1. 检查权限: `ls -l {resource}`
2. 修改权限: `chmod 644 {resource}` (Linux/Mac)
3. 使用不同的位置
4. 联系管理员

⚠️ 注意：修改权限前确保了解风险
```

### 模板 3: 无效输入

```markdown
❌ 错误：无效的输入

**输入**: {user_input}
**期望**: {expected_format}

输入格式不正确。

**正确格式**:
{format_description}

**示例**:
✅ {good_example_1}
✅ {good_example_2}
❌ {bad_example}

请重新输入：
```

## 最佳实践

### 1. 错误优先设计

```markdown
## 设计原则

在设计中优先考虑错误情况：

1. 这个操作可能失败吗？
2. 失败的原因有哪些？
3. 如何预防这些失败？
4. 失败时如何提示用户？
5. 如何恢复或重试？
```

### 2. 提供恢复选项

```markdown
## 恢复选项

不要只显示错误，还要提供解决方案：

❌ 不好：
```

错误：文件不存在

```

✅ 好：
```

❌ 错误：文件不存在

**文件**: config.json

建议：

1. 创建新配置文件
2. 从备份恢复
3. 使用默认配置

选择操作 (1/2/3):

```
```

### 3. 记录错误

```markdown
## 错误日志

记录错误以便调试：

**时间**: 2025-01-11 10:30:45
**操作**: 读取配置文件
**文件**: config.json
**错误**: 文件不存在
**用户输入**: ./config.json
**当前目录**: /home/user/project
**可用文件**: package.json, README.md
```

## 验收标准

完成练习后，检查：

- [ ] 覆盖所有主要错误类型
- [ ] 错误信息清晰友好
- [ ] 提供解决方案
- [ ] 有恢复选项
- [ ] 记录错误日志
- [ ] 防止级联失败

## 延伸挑战

1. **添加重试机制**
   在某些错误时自动重试

2. **错误报告**
   生成错误报告文件

3. **错误恢复**
   实现自动恢复策略

## 参考答案

完成练习后，可以查看 `solutions/intermediate/exercise-10.md` 对比参考答案。

## 相关资源

- [教程：测试 Skills](../../docs/tutorials/tutorial-04-testing-skills.md)
- [最佳实践：错误处理](../../docs/03-best-practices.md#错误处理)
- [高级模式：反馈循环](../../docs/04-advanced-patterns.md#反馈循环模式)

---

恭喜！完成这个练习后，你已经掌握了中级 Skills 开发的所有核心技能！
