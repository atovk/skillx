# 练习 7: 使用工具限制

**难度**：⭐⭐ 中级
**预计时间**：25 分钟

## 学习目标

完成这个练习后，你将：

- 理解为什么需要限制工具
- 掌握 `allowed-tools` 的使用
- 能够设计安全且功能完整的 Skills

## 前置知识

- 完成初级练习
- 熟悉基本工具（Read、Write、Bash）
- 了解工具权限的重要性

## 任务描述

创建一个 **只读**代码分析器，严格遵守"只读"原则，不修改任何文件。

### 场景

你需要创建一个 Skill 来分析代码质量，但是：

- 只能读取文件
- 不能修改任何内容
- 不能运行可能危险的命令
- 不能写入分析结果到文件（只显示给用户）

## 要求

### 1. 声明允许的工具

```yaml
---
name: readonly-analyzer
description: 只读分析代码质量，不修改任何文件
allowed-tools:
  - Read    # 只读文件
  - Grep    # 搜索内容
  - Glob    # 查找文件
  # 注意：不包含 Write 或 Bash
---
```

### 2. 工具选择指南

| 工具 | 是否安全 | 说明 |
|------|---------|------|
| `Read` | ✅ 安全 | 只读取内容 |
| `Grep` | ✅ 安全 | 只搜索内容 |
| `Glob` | ✅ 安全 | 只列出文件 |
| `Write` | ⚠️ 修改 | 会修改文件 |
| `Bash` | ⚠️ 危险 | 可能执行任意命令 |

### 3. 实现分析功能

虽然限制工具，但仍能实现强大功能：

#### 代码行数统计

```markdown
使用 Read 工具读取文件
统计行数、代码行、空行、注释行
```

#### 函数/类识别

```markdown
使用 Grep 搜索函数定义
- JavaScript: `function `
- Python: `def `
- Java: `public.*void`
```

#### 依赖分析

```markdown
使用 Grep 搜索 import/require 语句
分析项目依赖关系
```

### 4. 输出结果

**重要**：只显示结果，不保存到文件

```markdown
# 代码分析报告

**文件**: src/main.js

## 统计信息
- 总行数: 150
- 代码行: 120
- 空行: 20
- 注释行: 10

## 复杂度分析
[分析结果]

## 建议
[改进建议]

---
⚠️ 注意：此工具为只读，不会修改任何文件
```

## 安全原则

### 原则 1: 最小权限

只申请需要的工具：

```yaml
# ✅ 好：明确声明
allowed-tools:
  - Read
  - Grep

# ⚠️ 不好的做法：允许所有
# (不声明 allowed-tools)
```

### 原则 2: 明确告知

在输出中明确告知用户工具限制：

```markdown
## 安全说明

此 Skill 只使用只读工具：
- ✅ Read: 读取文件
- ✅ Grep: 搜索内容
- ❌ 不会修改任何文件
- ❌ 不会执行命令
```

### 原则 3: 验证不越界

在内容中明确说明不会越界：

```markdown
## 工作流程

1. 读取文件（使用 Read）
2. 分析内容（内存中处理）
3. 显示结果（只输出到终端）

**承诺**：绝不使用 Write 或 Bash 修改文件
```

## 实践练习

### 练习 1: 创建只读分析器

创建一个分析 JavaScript 代码的 Skill：

- 统计代码行数
- 识别所有函数
- 找出 console.log 语句
- 分析命名规范

**限制**：只能使用 Read、Grep、Glob

### 练习 2: 添加更多分析

在不增加工具的情况下，添加更多分析：

- 计算平均函数长度
- 识别重复代码
- 检查错误处理

### 练习 3: 优化输出

改进输出格式：

- 使用颜色/图标标记问题
- 按严重程度分类
- 提供具体的行号

## 提示

### 提示 1: 利用 Grep 的强大功能

Grep 可以做很多事，不需要 Write 或 Bash：

```markdown
# 查找函数定义
Grep: "function |=> "

# 查找导入
Grep: "^import |^require\("

# 查找 TODO 注释
Grep: "TODO|FIXME|XXX"
```

### 提示 2: 组合使用工具

```markdown
## 步骤 1: 使用 Glob 查找文件
查找所有 .js 文件

## 步骤 2: 使用 Read 读取文件
逐个读取文件内容

## 步骤 3: 使用 Grep 搜索模式
在内容中搜索特定模式

## 步骤 4: 在内存中分析
组合所有信息进行分析

## 步骤 5: 输出结果
只输出到终端，不保存
```

### 提示 3: 处理大文件

```markdown
## 大文件处理策略

如果文件很大：
1. 使用 Grep 只读取需要的部分
2. 分段读取和分析
3. 显示进度信息
4. 避免一次性加载全部内容
```

## 验收标准

完成练习后，检查：

- [ ] Frontmatter 正确声明 allowed-tools
- [ ] 只使用 Read、Grep、Glob
- [ ] 不尝试使用 Write 或 Bash
- [ ] 在输出中明确告知只读性质
- [ ] 功能完整且有用
- [ ] 有清晰的错误处理

## 常见错误

### 错误 1: 试图保存结果

```markdown
# ❌ 错误：尝试保存分析结果
使用 Write 工具保存 report.md

# ✅ 正确：只显示结果
在终端显示报告，告知用户可以手动复制
```

### 错误 2: 过度声明工具

```yaml
# ❌ 不好：声明了不需要的工具
allowed-tools:
  - Read
  - Write    # 不需要
  - Bash     # 不需要

# ✅ 好：只声明需要的工具
allowed-tools:
  - Read
  - Grep
```

### 错误 3: 没有告知限制

```markdown
# ❌ 不好：没有说明只读
## 代码分析结果
[结果]

# ✅ 好：明确说明只读
## 代码分析结果
[结果]

---
⚠️ 此工具为只读，未修改任何文件
```

## 延伸挑战

1. **添加文件类型检测**
   根据文件扩展名自动调整分析规则

2. **实现代码复杂度计算**
   只用 Read 和 Grep 计算圈复杂度

3. **创建交互式报告**
   允许用户选择查看不同的分析部分

## 参考答案

完成练习后，可以查看 `solutions/intermediate/exercise-07.md` 对比参考答案。

## 相关资源

- [工具限制参考](../../docs/reference/tool-restrictions.md)
- [最佳实践：安全考虑](../../docs/03-best-practices.md#安全考虑)
- [file-analyzer 示例](../../skills/02-file-operations/file-analyzer/)
